<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta name="abuseipdb-verification" content="DmbG28jg" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#414141">
    <meta name="apple-mobile-web-app-title" content="ギコっぽいぽい">
    <meta name="application-name" content="ギコっぽいぽい">
    <meta name="msapplication-TileColor" content="#c0c0c0">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#c0c0c0">
    <meta name="description" content="ギコッぽいぽいは配信機能付きのアバターチャットです。登録不要です。">
    <meta name="keywords" content="Gikopoipoi,ギコっぽいぽい">

    <link rel='stylesheet' href='/src/frontend/style/main.css' />
    <link rel='stylesheet' href='/src/frontend/style/theme-dark.css' />
    <link rel='stylesheet' href='/src/frontend/style/theme-shaddox.css' />
    <link rel='stylesheet' href='/src/frontend/style/theme-nostalgic.css' />
    <link rel='stylesheet' href='chess/css/chessboard-1.0.0.min.css' />
    <link href="font-awesome/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="libraries/jquery-ui/jquery-ui.css">
    <style id="highlighted-user-style"></style>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>ギコっぽいぽい</title>
</head>

<body>
    <div id="vue-app">
        <div id="page-container" ref="page-container" v-cloak :class="['theme-' + uiTheme]" v-bind:lang="$i18next.language">
            <login-page
                v-if="appState == 'login'"
                :password-input-visible="passwordInputVisible"
                :is-logging-in="isLoggingIn"
                :area-id="areaId"
                :site-areas="siteAreas"
                :site-areas-info="siteAreasInfo"
                @login="login"
                @setlanguage="setLanguage"
            >
            </login-page>
            <div id="stage" v-if="appState == 'stage'">
                <h2 class="big-red-alert" v-if="connectionLost && !connectionRefused">
                    {{ $t("msg.connection_lost") }}
                </h2>
                <h2 class="big-red-alert" v-if="pageRefreshRequired">
                    {{ $t("msg.page_refresh_required") }}
                </h2>
                <h2 v-if="connectionRefused">
                    {{ $t("msg.connection_refused") }}
                    <a href="/">{{ $t("ui.back_to_homepage") }}</a>
                </h2>
                <div id="main-section" v-bind:class="{'log-above-toolbar': showLogAboveToolbar}">
                    <div id="canvas-container" v-if="!connectionRefused">
                        <canvas id="room-canvas" tabindex="1"
                            v-on:keydown="handleCanvasKeydown($event)"
                            v-on:keyup="handleCanvasKeyup($event)"
                            v-on:blur="handleCanvasBlur()"
                            v-on:mousedown="handleCanvasPointerDown($event)"
                            v-on:mousemove="handleCanvasPointerMove($event)"
                            v-on:touchstart="handleCanvasPointerDown($event)"
                            v-on:touchmove="handleCanvasPointerMove($event)"
                            v-on:wheel="handleCanvasWheel($event)"
                            v-on:click="canvasClick"
                            ></canvas>
                        <div id="infobox-container">
                            <div id="infobox" v-if="isInfoboxVisible && currentRoom !== null">
                                <table>
                                    <tr>
                                        <td>{{ $t("ui.infobox_label_area") }}</td>
                                        <td>{{ $t("area." + currentRoom.group) }}</td>
                                    </tr>
                                    <tr>
                                        <td>{{ $t("ui.infobox_label_room") }}</td>
                                        <td>{{ currentRoom.id && $t("room."+currentRoom.id) }}</td>
                                    </tr>
                                    <tr>
                                        <td>{{ $t("ui.infobox_label_user_name") }}</td>
                                        <td>{{ myUserID && users && users[myUserID] ? users[myUserID].name : '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>{{ $t("ui.infobox_label_user_count") }}</td>
                                        <td>{{ serverStats.userCount }}</td>
                                    </tr>
                                </table>
                                <span id="infobox-streamcount">
                                    {{ $t("ui.infobox_label_stream_count") }} {{ serverStats.streamCount }}
                                </span>
                            </div>
                            <button id="infobox-button" class="canvas-button-top-right" v-on:click="toggleInfobox"
                                tabindex="-1"></button>
                        </div>
                    </div>
                    <div id="toolbar" v-if="!connectionRefused">
                        <div id="toolbar-text-input">
                            {{ $t("ui.label_input") }} <textarea id="input-textbox"
                                v-on:keypress="handleMessageInputKeypress($event)"
                                v-on:keydown="handleMessageInputKeydown($event)"
                                tabindex="2"
                                maxlength="500"></textarea>
                            <button id="send-button" v-on:click="sendMessageToServer" tabindex="3">{{ $t("ui.button_send") }}</button>
                        </div>
                        <div id="toolbar-buttons">
                            <div class="tooltip-section tooltip-volume-section">
                                <label>{{ $t("ui.sound_effect") }}</label>
                                <div id="sound-effect-volume"></div>
                            </div>
                            <div class="tooltip-section tooltip-volume-section" v-show="enableTextToSpeech">
                                <label>{{ $t("ui.tts_volume") }}</label>
                                <div id="voice-volume"></div>
                            </div>
                            <div class="tooltip-section" v-if="isCommandSectionVisible">
                                <button id="btn-rula" v-on:click="requestRoomList()">{{ $t("ui.button_rula") }}</button>
                                <button id="btn-list" v-on:click="openUserListPopup()">{{ $t("ui.button_list") }}</button>
                            </div>
                            <div class="tooltip-section">
                                <button v-on:click="openPreferencesPopup"
                                        v-bind:title="$t('ui.button_preferences')"
                                        class="fas fa-cogs"></button>
                                <button v-if="notificationPermissionsGranted"
                                        v-on:click="toggleDesktopNotifications"
                                        v-bind:title="$t('ui.preferences_show_notifications')"
                                        class="fas"
                                        v-bind:class="{'fa-bell': showNotifications, 'fa-bell-slash': !showNotifications}"></button>
                            </div>
                            <div class="tooltip-section tooltip-movement-section" v-if="isMoveSectionVisible">
                                <div class='tooltip-section-title'>
                                    <div>{{ $t("ui.label_move") }}</div>
                                </div>
                                <div class="non-wrappable-buttons">
                                    <button id="btn-move-left" class="arrow-button arrow-button-left"
                                            v-on:mousedown="setMovementDirection($event, 'left')"
                                            v-on:mouseup="setMovementDirection($event, null)"
                                            v-on:touchstart="setMovementDirection($event, 'left')"
                                            v-on:touchend="setMovementDirection($event, null)">&nbsp;</button
                                    ><button id="btn-move-up" class="arrow-button arrow-button-up"
                                            v-on:mousedown="setMovementDirection($event, 'up')"
                                            v-on:mouseup="setMovementDirection($event, null)"
                                            v-on:touchstart="setMovementDirection($event, 'up')"
                                            v-on:touchend="setMovementDirection($event, null)">&nbsp;</button>
                                </div>
                                <div class="non-wrappable-buttons">
                                    <button id="btn-move-down" class="arrow-button arrow-button-down"
                                            v-on:mousedown="setMovementDirection($event, 'down')"
                                            v-on:mouseup="setMovementDirection($event, null)"
                                            v-on:touchstart="setMovementDirection($event, 'down')"
                                            v-on:touchend="setMovementDirection($event, null)">&nbsp;</button
                                    ><button id="btn-move-right" class="arrow-button arrow-button-right"
                                            v-on:mousedown="setMovementDirection($event, 'right')"
                                            v-on:mouseup="setMovementDirection($event, null)"
                                            v-on:touchstart="setMovementDirection($event, 'right')"
                                            v-on:touchend="setMovementDirection($event, null)">&nbsp;</button>
                                </div>
                            </div>
                            <div class="tooltip-section tooltip-bubble-position-section" v-if="isBubbleSectionVisible">
                                <div class='tooltip-section-title'>
                                    <div>{{ $t("ui.label_bubble") }}</div>
                                </div>
                                <div class="non-wrappable-buttons">
                                    <button class="arrow-button arrow-button-left" v-on:click="sendNewBubblePositionToServer('left')">&nbsp;</button
                                    ><button class="arrow-button arrow-button-up" v-on:click="sendNewBubblePositionToServer('up')">&nbsp;</button>
                                </div>
                                <div class="non-wrappable-buttons">
                                    <button class="arrow-button arrow-button-down" v-on:click="sendNewBubblePositionToServer('down')">&nbsp;</button
                                    ><button class="arrow-button arrow-button-right" v-on:click="sendNewBubblePositionToServer('right')">&nbsp;</button>
                                </div>
                            </div>
                            <div class="tooltip-section">
                                <button id="logout-button" v-if="isLogoutButtonVisible" v-on:click="logout" class="fas fa-sign-out-alt" v-bind:title="$t('ui.button_logout')"></button>
                            </div>
                        </div>
                    </div>
                    <div id='chat-log-container'>
                        <div id='chat-log-label'>{{ $t("ui.label_log") }}</div>
                        <div id="chatLog" tabindex="-1" v-bind:class="{'underlined-usernames': underlinedUsernames, 'timestamps-in-copied-log': timestampsInCopiedLog, 'ignore-indicators-in-log': showIgnoreIndicatorInLog, 'log-dividers': showLogDividers}" v-on:keydown="handlechatLogKeydown($event)">
                        </div>
                        <div id="dummyElement">
                            <!-- This element is needed only to make chatLog.nextSibling return something, so that we can 
                                use it with setBaseAndExtent() when pressing Ctrl+A to select the entire chat log -->
                        </div>
                    </div>
                </div>
                <div id="video-streams" v-if="!connectionRefused">
                    <div v-for="(streamSlot, index) in streams" v-bind:class="{'stream-is-active': streamSlot.isActive}">
                        <hr v-if="index != 0" />
                        <div>
                            {{ $t("ui.label_stream", {index: index+1}) }}<span
                                v-if="streamSlot.isActive" class="stream-title"><username-label :user-id="streamSlot.userId"></username-label>
                                <!-- NOTE 2: username component handles cases where the user id is missing in users, but unsure if the ideas mentioned in the note
                                    are still relevant or not.
                                    NOTE: Above, I'm using the null propagator in the `users[streamSlot.userId]?.name` expression for
                                           this regrettable reason: when changing room, updateRoomState() does a lot of stuff, among which
                                           there is the updating of this.users and this.streams. Unfortunately, there are quite a lot of
                                           asynchronous operations (using await) between those two updates, which means that after this.users
                                           is updated with the users of the new room, this.streams still has the stream slots of the old room,
                                           but vue3 still tries to rerender the stream slots, meaning that users[streamSlot.userId] will return
                                           undefined. Maybe a better solution would be to make sure that stream slots are rerendered only if 
                                           this.streams is updated? I'm not sure how to do that. -->
                                <span v-bind:title="$t('ui.visible_only_to_specific_users_stream')"
                                      v-if="streamSlot.isVisibleOnlyToSpecificUsers"
                                      class="fas fa-lock visible-only-to-specific-users-stream-icon"></span>
                            </span>
                            <span v-if="!streamSlot.isActive" class="stream-title">OFF</span>
                        </div>
                        <div :id="'video-container-' + index"
                             class='video-container pinned-video'
                             v-on:dblclick="onVideoDoubleClick($event, index)"
                             v-show="streamSlot.withVideo
                                     && ((takenStreams[index] && streamSlot.isReady)
                                         || index == streamSlotIdInWhichIWantToStream)
                                     && streamSlot.isAllowed">
                            <button
                                class="fas fa-thumbtack pin-video-button"
                                v-show="takenStreams[index] || (streamSlot.isActive && index == streamSlotIdInWhichIWantToStream)"
                                v-on:click="toggleVideoSlotPinStatus(index)"></button>
                            <video :id="'local-video-' + index"
                                v-show="streamSlot.isActive && index == streamSlotIdInWhichIWantToStream"
                                v-on:click="playVideo($event)"
                                v-bind:title="clientSideStreamData[index].isSeparateTab ? $t('ui.double_click_to_toggle_fullscreen') : $t('ui.double_click_to_move_to_new_tab')"
                                v-bind:class="{'video-being-played': index == streamSlotIdInWhichIWantToStream}"
                                autoplay muted playsinline></video>
                            <video :id="'received-video-' + index"
                                v-show="takenStreams[index] && index != streamSlotIdInWhichIWantToStream"
                                v-on:click="playVideo($event)"
                                v-bind:title="clientSideStreamData[index].isSeparateTab ? $t('ui.double_click_to_toggle_fullscreen') : $t('ui.double_click_to_move_to_new_tab')"
                                v-bind:class="{'video-being-played': index != streamSlotIdInWhichIWantToStream}"
                                autoplay playsinline></video>
                            <img class="vtuber-character"
                                v-if="streamSlot.streamIsVtuberMode"
                                :src="getAvatarSpriteForUser(streamSlot.userId)"
                                v-bind:class="{'jumping': streamSlot.isJumping}" />
                            <div class="nico-nico-messages-container"
                                 v-if="streamSlot.isNicoNicoMode">
                            </div>
                        </div>
                        <div :id="'vu-meter-container-' + index"
                             v-show="streamSlot.isActive
                                     && streamSlot.withSound
                                     && (index == streamSlotIdInWhichIWantToStream || (takenStreams[index] && isStreamInboundVuMeterEnabled))
                                     && streamSlot.isAllowed">
                            <div
                                :id="'vu-meter-bar-primary-' + index"
                                v-bind:class="{'inbound-vu-meter-bar': takenStreams[index], 'outbound-vu-meter-bar': index == streamSlotIdInWhichIWantToStream}"></div>
                            <div
                                :id="'vu-meter-bar-secondary-' + index"
                                v-bind:class="{'inbound-vu-meter-bar': takenStreams[index], 'outbound-vu-meter-bar': index == streamSlotIdInWhichIWantToStream}"></div>
                        </div>
                        <div
                            v-if="takenStreams[index]
                                  && streamSlot.isReady
                                  && streamSlot.withSound
                                  && index != streamSlotIdInWhichIWantToStream
                                  && streamSlot.isAllowed"
                            class="audio-stream-controls-container"
                            v-bind:class="{'listener-connected': clientSideStreamData[index].isListenerConnected}">
                            <div class="audio-stream-controls-spinner">
                                <img src="spinner.svg" />
                            </div>
                            <div class="audio-stream-controls">
                                <label for="stream-volume">{{ $t("ui.volume") }}</label>
                                <input type="range" :id="'volume-' + index" v-on:change="changeStreamVolume(index)"
                                    name="stream-volume" min="0" max="1" step="0.01" v-model.number="slotVolume[index]">
                                <input
                                    :id="'pan-knob-' + index"
                                    type="range"
                                    class="input-knob"
                                    data-diameter="16"
                                    min="-1"
                                    max="1"
                                    step="0.01"
                                    value="0"
                                    :data-bgcolor="isUiBackgroundDark ? 'black' : '#4d4d9f'"
                                    :data-fgcolor="isUiBackgroundDark ? '#ff0000' : '#ffffff'"
                                    v-on:input="onPanChanged(index, $event)"
                                    v-on:dblclick="resetPan(index)" />
                            </div>
                            <div class="audio-stream-controls">
                                <div>
                                    <label :for="'enable-compression-' + index">{{ $t("ui.enable_compression") }}</label>
                                    <input type="checkbox"
                                        :id="'enable-compression-' + index"
                                        v-if="inboundAudioProcessors[index]"
                                        v-model="inboundAudioProcessors[index].isBoostEnabled"
                                        v-on:change="onCompressionChanged(index)">
                                </div>
                                <div>
                                    <label :for="'numeric-value-control-' + index">{{ $t("ui.gain") }}</label>
                                    <numeric-value-control
                                        :id="'numeric-value-control-' + index"
                                        :min="0"
                                        :max="Number.MAX_VALUE"
                                        :default="0"
                                        @value-changed="gain => onGainChanged(index, gain)"></numeric-value-control>
                                </div>
                            </div>
                        </div>
                        <div v-if="streamSlotIdInWhichIWantToStream == index">

                        </div>
                        <div class="stream-buttons" v-if="!streamSlot.isActive || streamSlot.isAllowed">
                            <button :id="'take-stream-button-' + index"
                                v-bind:class="{'red-button': streamSlot.isReady}"
                                v-if="!takenStreams[index]
                                      && streamSlot.userId != myUserID
                                      && !wantToStream
                                      && (isStreamAutoResumeEnabled || streamSlot.isReady)"
                                v-on:click="wantToTakeStream(index)">
                                {{ $t("ui.button_stream_take") }}
                            </button>
                            <button :id="'drop-stream-button-' + index"
                                v-if="takenStreams[index]
                                      && streamSlot.userId != myUserID
                                      && !wantToStream"
                                v-on:click="wantToDropStream(index)">
                                {{ $t("ui.button_stream_drop") }}
                            </button>
                            <button :id="'start-video-streaming-button-' + index"
                                v-if="!streamSlot.isActive && !wantToStream
                                      && streamSlotIdInWhichIWantToStream == null"
                                v-on:click="openStreamPopup(index)">
                                {{ $t("ui.button_stream_start") }}
                            </button>
                            <button :id="'stop-streaming-button-' + index"
                                v-if="streamSlotIdInWhichIWantToStream == index"
                                v-on:click="stopStreaming">
                                {{ $t("ui.button_stream_stop") }}
                            </button>

                            <!-- enable/disable feedback buttons -->
                            <button
                                v-if="streamSlotIdInWhichIWantToStream == index
                                    && streamSlot.withSound
                                    && !outboundAudioProcessor?.isFeedbackEnabled"
                                v-on:click="enableFeedback"
                                class="feedback-button"
                                v-bind:title="$t('ui.button_stream_enable_feedback')">
                                <span class="fas fa-volume-mute"></span>
                            </button>
                            <button
                                v-if="streamSlotIdInWhichIWantToStream == index
                                    && streamSlot.withSound
                                    && outboundAudioProcessor?.isFeedbackEnabled"
                                v-on:click="disableFeedback"
                                class="feedback-button red-button"
                                v-bind:title="$t('ui.button_stream_disable_feedback')">
                                <span class="fas fa-volume-up"></span>
                            </button>

                            <!-- mute/unmute buttons-->
                            <button
                                v-if="streamSlotIdInWhichIWantToStream == index
                                    && streamSlot.withSound
                                    && !outboundAudioProcessor?.isMute"
                                v-on:click="mute"
                                class="mute-unmute-button"
                                v-bind:title="$t('ui.button_stream_mute')">
                                <span class="fas fa-microphone"></span>
                            </button>
                            <button
                                v-if="streamSlotIdInWhichIWantToStream == index
                                    && streamSlot.withSound
                                    && outboundAudioProcessor?.isMute"
                                v-on:click="unmute"
                                class="mute-unmute-button"
                                v-bind:title="$t('ui.button_stream_unmute')">
                                <span class="fas fa-microphone-slash"></span>
                            </button>
                        </div>
                        <div class="stream-buttons" v-if="streamSlotIdInWhichIWantToStream == index && streamSlot.withSound">
                            <label>{{ $t("ui.voice_changer") }}</label>
                            <voice-changer-control
                                :id="'pitch-shift-' + index"
                                :audioProcessor="outboundAudioProcessor"
                                :cacca="1234">
                            </voice-changer-control>
                        </div>
                    </div>
                    <template v-if="currentRoom !== null && currentRoom.games" v-for="(game, index) in currentRoom.games">
                        <hr v-if="streams.length || index > 0" />
                        <chessboard-slot
                            v-if="game == 'chess' && chessboardState"
                            :chessboard-state="chessboardState"
                            ></chessboard-slot>
                        <janken-slot
                            v-if="game == 'janken' && jankenState"
                            :janken-state="jankenState"
                            ></janken-slot>
                    </template>
                </div>

                <div class="popup-overlay" v-if="isRulaPopupOpen" v-on:click="closeRulaPopup"></div>
                <div id="rula-popup" class="popup" v-if="isRulaPopupOpen" v-on:keydown="handleRulaPopupKeydown($event)" tabindex="-1">
                    <div class="popup-titlebar">
                        <div class="popup-title">{{ $t("ui.rula_menu_title") }}</div>
                        <div class="popup-titlebar-item">
                            <label for="rula-room-group">{{ $t("ui.rula_menu_label_group") }} </label>
                            <select id="rula-room-group" v-model="rulaRoomGroup" v-on:change="prepareRulaRoomList()">
                                <option value="all">{{ $t("ui.rula_menu_group_option_all") }}</option>
                                <option value="gikopoipoi">{{ $t("area.gikopoipoi") }}</option>
                                <option value="gikopoi">{{ $t("area.gikopoi") }}</option>
                                <option value="bar_giko">{{ $t("area.bar_giko") }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="popup-content">
                        <table class="popup-table popup-selectable-table popup-sortable-table">
                            <colgroup>
                                <col id="rula-menu-column-room-name" />
                                <col id="rula-menu-column-user-count" />
                                <col id="rula-menu-column-streamers" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th v-on:click="setRulaRoomListSortKey('sortName')">
                                        {{ $t("ui.rula_menu_column_room_name") }}
                                    </th>
                                    <th v-on:click="setRulaRoomListSortKey('userCount')">
                                        {{ $t("ui.rula_menu_column_user_count") }}
                                    </th>
                                    <th v-on:click="setRulaRoomListSortKey('streamerCount')">
                                        {{ $t("ui.rula_menu_column_streamers") }}
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="room in preparedRoomList"
                                    :id="'room-tr-' + room.id"
                                    v-bind:class="{'popup-row-is-selected': rulaRoomSelection == room.id}"
                                    v-on:click="selectRoomForRula(room.id)"
                                    v-on:dblclick="rula(room.id)">
                                    <td>{{ $t("room." + room.id) }}</td>
                                    <td>{{ room.userCount }}</td>
                                    <td>
                                        <span v-for="(stream, index) in room.streams">
                                            <span v-if="index !== 0">/</span>
                                            {{ stream.userName }}
                                            <span v-bind:title="$t('ui.visible_only_to_specific_users_stream')"
                                                  v-if="stream.isVisibleOnlyToSpecificUsers"
                                                  class="fas fa-lock visible-only-to-specific-users-stream-icon"></span>
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="popup-buttons">
                        <button v-on:click="rula(rulaRoomSelection)">{{ $t("ui.rula_menu_button_rula") }}</button><button
                            v-on:click="closeRulaPopup">{{ $t("ui.popup_button_cancel") }}</button>
                    </div>
                </div>

                <div class="popup-overlay" v-if="isUserListPopupOpen" v-on:click="closeUserListPopup"></div>
                <div id="user-list-popup" class="popup" v-if="isUserListPopupOpen">
                    <div class="popup-titlebar">
                        <div class="popup-title">{{ $t("ui.user_list_popup_title", {userCount: getUserListForListPopup().length}) }}</div>
                    </div>
                    <div class="popup-item">{{ $t("ui.user_list_popup_blurb") }}</div>
                    <div class="popup-content">
                        <table class="popup-table">
                            <colgroup>
                                <col id="user-list-column-user-name" />
                                <col id="user-list-column-ignore-button" />
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>{{ $t("ui.user_list_popup_column_user_name") }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr :id="'user-list-element-' + u.id"
                                    v-for="u in getUserListForListPopup()"
                                    v-bind:class="{'popup-row-is-selected': u.id == highlightedUserId}">
                                    <td>
                                        <div v-on:click="u.isInRoom && highlightUser(u.id, u.name)">
                                            <span v-bind:title="$t('ui.user_not_in_room')"
                                                  class="user-not-in-room-warning fas fa-exclamation-triangle"
                                                  v-if="!u.isInRoom"></span>
                                            <img v-bind:title="$t('ui.user_inactive')"
                                                 v-if="u.isInactive"
                                                 class="inactive-user-icon"
                                                 src="zzz-sleep-symbol.svg"
                                                  ></img>
                                            <img v-if="isStreaming()
                                                       && streamTarget == 'specific_users'
                                                       && allowedListenerIDs.has(u.id)"
                                                 class="enabled-disabled-listener-icon"
                                                 src="enabled-listener.svg"
                                                  ></img>
                                            <img v-if="isStreaming()
                                                       && streamTarget == 'specific_users'
                                                       && !allowedListenerIDs.has(u.id)"
                                                 class="enabled-disabled-listener-icon"
                                                 src="disabled-listener.svg"
                                                  ></img>
                                            {{ u.name }}
                                        </div>
                                        <button v-if="isStreaming()
                                                      && streamTarget == 'specific_users'
                                                      && !allowedListenerIDs.has(u.id)"
                                                v-on:click="giveStreamToUser(u.id)">{{ $t("ui.user_list_popup_give_stream") }}</button>
                                        <button v-if="isStreaming()
                                                      && streamTarget == 'specific_users'
                                                      && allowedListenerIDs.has(u.id)"
                                                v-on:click="revokeStreamToUser(u.id)">{{ $t("ui.user_list_popup_revoke_stream") }}</button>

                                        <button v-if="ignoredUserIds.has(u.id)" v-on:click="unignoreUser(u.id)">{{ $t("ui.user_list_popup_unignore") }}</button>
                                        <button v-if="!ignoredUserIds.has(u.id)" v-on:click="ignoreUser(u.id)">{{ $t("ui.user_list_popup_ignore") }}</button>

                                        <button v-on:click="blockUser(u.id)">{{ $t("ui.user_list_popup_block") }}</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="popup-buttons">
                        <button v-on:click="closeUserListPopup">{{ $t("ui.user_list_popup_close") }}</button>
                    </div>
                </div>


                <div class="popup-overlay" v-if="isStreamPopupOpen" v-on:click="closeStreamPopup"></div>
                <fieldset id="stream-popup" class="popup" v-if="isStreamPopupOpen" :disabled="waitingForDevicePermission">
                    <div class="popup-titlebar">
                        <div class="popup-title">{{ $t("ui.stream_form_title") }}</div>
                    </div>
                    <div class="popup-content">
                        <div class='popup-item'>
                            <span>{{ $t("ui.stream_form_mode") }}</span><input type="radio"
                                id="stream-form-video-sound-mode" value="video_sound"
                                v-model="streamMode" v-on:change="storeSet('streamMode')"><label
                                for="stream-form-video-sound-mode">{{ $t("ui.stream_form_video_sound_mode") }}</label>

                            <input type="radio" id="stream-form-sound-only-mode" value="sound"
                                v-model="streamMode" v-on:change="storeSet('streamMode')"><label
                                for="stream-form-sound-only-mode">{{ $t("ui.stream_form_sound_only_mode") }}</label>

                            <input type="radio" id="stream-form-video-only-mode" value="video"
                                v-model="streamMode" v-on:change="storeSet('streamMode')"><label
                                for="stream-form-video-only-mode">{{ $t("ui.stream_form_video_only_mode") }}</label>
                        </div>
                        <div class='popup-item' v-if="streamMode != 'sound'">
                            <input type="checkbox" id="stream-form-screen-capture"
                                v-model="streamScreenCapture" v-on:change="storeSet('streamScreenCapture')"><label
                                for="stream-form-screen-capture">{{ $t("ui.stream_form_screen_capture") }}</label>
                        </div>
                        <div class='popup-item'>
                            <span>{{ $t("ui.stream_form_stream_target") }}</span>

                            <input type="radio" id="stream-form-visible-to-all-room" value="all_room" v-model="streamTarget"><label
                                for="stream-form-visible-to-all-room">{{ $t("ui.stream_form_visible_to_all_room") }}</label>

                            <input type="radio" id="stream-form-visible-only-to-specific-users" value="specific_users" v-model="streamTarget"><label
                                for="stream-form-visible-only-to-specific-users">{{ $t("ui.stream_form_visible_only_to_specific_users") }}</label>

                        </div>
                        <div class='popup-item' v-if="streamMode == 'video_sound' || streamMode == 'video'">
                            <input type="checkbox" id="stream-form-vtuber-mode" v-model="streamIsVtuberMode"><label
                                for="stream-form-vtuber-mode">{{ $t("ui.stream_form_vtuber_mode") }}</label>
                        </div>
                        <div class='popup-item' v-if="streamMode == 'video_sound' || streamMode == 'video'">
                            <input type="checkbox" id="stream-form-niconico-mode" v-model="isNicoNicoMode"><label
                                for="stream-form-niconico-mode">{{ $t("ui.stream_form_niconico_mode") }}</label>
                        </div>
                        <div v-if="streamMode != 'video'">
                            <div class='popup-item'>
                                <button v-if="!displayAdvancedStreamSettings"
                                    v-on:click="storeSet('displayAdvancedStreamSettings', true)">{{ $t("ui.stream_form_show_advanced") }}</button>
                                <button v-if="displayAdvancedStreamSettings"
                                    v-on:click="storeSet('displayAdvancedStreamSettings', false)">{{ $t("ui.stream_form_hide_advanced") }}</button>
                            </div>
                            <div v-if="displayAdvancedStreamSettings">
                                <div class='popup-item' v-if="streamMode != 'sound' && streamScreenCapture">
                                    <div>
                                        <input type="checkbox" id="stream-form-screen-capture-audio"
                                            v-model="streamScreenCaptureAudio" v-on:change="storeSet('streamScreenCaptureAudio')"><label
                                            for="stream-form-screen-capture-audio">{{ $t("ui.stream_form_screen_capture_audio") }}</label>
                                    </div>
                                    <div class='popup-notice'>{{ $t("ui.stream_form_screen_capture_audio_notice") }}</div>
                                </div>
                                <!-- hide advanced audio settings for video only streams and streams with screen capture audio -->
                                <div class='popup-item' v-if="!streamScreenCapture || !(streamScreenCaptureAudio && streamMode == 'video_sound')">
                                    <div>
                                        <input type="checkbox" id="stream-form-echo-cancellation"
                                            v-model="streamEchoCancellation" v-on:change="storeSet('streamEchoCancellation')"
                                            ><label for="stream-form-echo-cancellation">{{
                                            $t("ui.stream_form_echo_cancellation") }}</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="stream-form-noise-suppression"
                                            v-model="streamNoiseSuppression" v-on:change="storeSet('streamNoiseSuppression')"
                                            ><label for="stream-form-noise-suppression">{{
                                            $t("ui.stream_form_noise_suppression") }}</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="stream-form-auto-gain"
                                            v-model="streamAutoGain" v-on:change="storeSet('streamAutoGain')"
                                            ><label
                                            for="stream-form-auto-gain">{{ $t("ui.stream_form_auto_gain") }}</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="popup-buttons">
                        <button v-on:click="showDeviceSelectionPopup">{{ $t("ui.stream_form_button_stream") }}</button><button
                            v-on:click="closeStreamPopup">{{ $t("ui.popup_button_cancel") }}</button>
                    </div>
                </fieldset>

                <div class="popup-overlay" v-if="isPreferencesPopupOpen" v-on:click="closePreferencesPopup"></div>
                <div class="popup" v-if="isPreferencesPopupOpen">
                    <div class="popup-titlebar">
                        <div class="popup-title">{{ $t("ui.preferences_title") }}</div>
                    </div>
                    <div class="popup-content">
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_general") }}</div>
                            <div class='popup-item'>
                                <label for="preferences-ui-theme">{{ $t("ui.preferences_ui_theme") }}</label>
                                <select id="preferences-ui-theme" v-model="uiTheme" v-on:change="handleUiTheme">
                                    <option value="gikopoi">{{ $t("ui.preferences_ui_theme_gikopoi") }}</option>
                                    <option value="shaddox">{{ $t("ui.preferences_ui_theme_shaddox") }}</option>
                                    <option value="dark">{{ $t("ui.preferences_ui_theme_dark") }}</option>
                                    <option value="nostalgic">{{ $t("ui.preferences_ui_theme_nostalgic") }}</option>
                                </select>
                            </div>
                            <div class='popup-item' v-if="!getSiteArea().restrictLanguage">
                                <label for="preferences-language">{{ $t("ui.preferences_language") }}</label>
                                <select id="preferences-language" v-model="language" v-on:change="handleLanguageChange">
                                    <template v-for="lang in getLangEntries()">
                                        <option :value="lang.id">{{ lang.name }}</option>
                                        <option disabled v-if="lang.endOfTopEntries">———</option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_tts") }}</div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-text-to-speech"
                                    v-model="enableTextToSpeech" v-on:change="handleEnableTextToSpeech"><label
                                    for="preferences-text-to-speech">{{ $t("ui.preferences_enable_text_to_speech") }}</label>
                            </div>
                            <div class='popup-item'>
                                <label for="preferences-tts-voice">{{ $t("ui.preferences_tts_voice") }}</label>
                                <select id="preferences-tts-voice" v-model="ttsVoiceURI" v-on:change="changeVoice">
                                    <option value="automatic">{{ $t("ui.preferences_tts_voice_automatic") }}</option>
                                    <option value="animalese">{{ $t("ui.preferences_tts_voice_animalese") }}</option>
                                    <option v-for="voice in availableTTSVoices" :value="voice.voiceURI">{{ voice.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_chat") }}</div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-shift-enter"
                                    v-model="isNewlineOnShiftEnter" v-on:change="storeSet('isNewlineOnShiftEnter')"><label
                                    for="preferences-shift-enter">{{ $t("ui.preferences_shift_enter") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-underlined-usernames"
                                    v-model="underlinedUsernames" v-on:change="storeSet('underlinedUsernames')"><label
                                    for="preferences-underlined-usernames">{{ $t("ui.preferences_underlined_usernames") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-timestamps-in-copied-log"
                                    v-model="timestampsInCopiedLog" v-on:change="storeSet('timestampsInCopiedLog')"><label
                                    for="preferences-timestamps-in-copied-log">{{ $t("ui.preferences_timestamps_in_copied_log") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-ignore-indicator-in-log"
                                    v-model="showIgnoreIndicatorInLog" v-on:change="storeSet('showIgnoreIndicatorInLog')"><label
                                    for="preferences-ignore-indicator-in-log">{{ $t("ui.preferences_ignore_indicator_in_log") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-ignore-on-block"
                                    v-model="isIgnoreOnBlock" v-on:change="storeSet('isIgnoreOnBlock')"><label
                                    for="preferences-ignore-on-block">{{ $t("ui.preferences_ignore_on_block") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-show-log-above-toolbar"
                                    v-model="showLogAboveToolbar" v-on:change="storeSet('showLogAboveToolbar')"><label
                                    for="preferences-show-log-above-toolbar">{{ $t("ui.preferences_show_log_above_toolbar") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-show-log-dividers"
                                    v-model="showLogDividers" v-on:change="storeSet('showLogDividers')"><label
                                    for="preferences-show-log-dividers">{{ $t("ui.preferences_show_log_dividers") }}</label>
                            </div>
                            <div class='popup-item'>
                                <button v-on:click="clearLog">{{ $t("ui.preferences_clear_log") }}</button>
                            </div>
                        </div>
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_notifications") }}</div>
                            <div class='popup-item'>
                                <div>
                                    <input type="checkbox" id="preferences-show-notifications"
                                        v-model="showNotifications" v-on:change="handleShowNotifications"><label
                                        for="preferences-show-notifications">{{ $t("ui.preferences_show_notifications") }}</label>
                                </div>
                                <div v-if="!notificationPermissionsGranted" class="popup-notice">{{ $t("ui.notifications_are_denied") }}</div>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-login-sound-enabled"
                                    v-model="isLoginSoundEnabled" v-on:change="storeSet('isLoginSoundEnabled')"><label
                                    for="preferences-login-sound-enabled">{{ $t("ui.preferences_login_sound_enabled") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-message-sound-enabled"
                                    v-model="isMessageSoundEnabled" v-on:change="storeSet('isMessageSoundEnabled')"><label
                                    for="preferences-message-sound-enabled">{{ $t("ui.preferences_message_sound_enabled") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="enable-coin-sound"
                                               v-model="isCoinSoundEnabled" v-on:change="toggleCoinSound"><label
                                   for="enable-coin-sound">{{ $t("ui.preferences_enable_coin_sound")}}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-name-mention-sound-enabled"
                                    v-model="isNameMentionSoundEnabled" v-on:change="handleNameMentionSoundEnabled"><label
                                    for="preferences-name-mention-sound-enabled">{{ $t("ui.preferences_name_mention_sound_enabled") }}</label>
                            </div>
                            <div class='popup-item'>
                                <div>
                                    <label for="preferences-custom-mention-sound-pattern">{{ $t("ui.preferences_custom_mention_sound_pattern") }}</label>
                                    <input type="text" id="preferences-custom-mention-sound-pattern"
                                        v-model="customMentionSoundPattern" v-on:change="handleCustomMentionSoundPattern">
                                </div>
                                <div class='popup-notice'>{{ $t("ui.preferences_custom_mention_sound_notice") }}</div>
                            </div>
                        </div>
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_game") }}</div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-name-bg"
                                    v-model="showUsernameBackground" v-on:click="toggleUsernameBackground"><label
                                    for="preferences-name-bg">{{ $t("ui.preferences_name_bg") }}</label>
                            </div>
                            <div class='popup-item'>
                                <label for="preferences-bubble-opacity">{{ $t("ui.preferences_bubble_opacity") }}</label>
                                <input type="range" id="preferences-bubble-opacity"
                                    min="50" max="100" v-model="bubbleOpacity" v-on:change="handleBubbleOpacity"><div
                                    class='preferences-percentage'>{{ bubbleOpacity }}%</div>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-crisp-mode"
                                    v-model="isCrispModeEnabled" v-on:change="handleCrispModeEnabled"><label
                                    for="preferences-crisp-mode">{{ $t("ui.preferences_crisp_mode") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-low-quality"
                                    v-model="isLowQualityEnabled" v-on:change="handleLowQualityEnabled"><label
                                    for="preferences-low-quality">{{ $t("ui.preferences_low_quality") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-disable-idle-animations"
                                    v-model="isIdleAnimationDisabled" v-on:change="handleIdleAnimationDisabled"><label
                                    for="preferences-disable-idle-animations">{{ $t("ui.preferences_disable_idle_animations") }}</label>
                            </div>
                        </div>
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_streams") }}</div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-streams-auto-resume"
                                    v-model="isStreamAutoResumeEnabled" v-on:change="storeSet('isStreamAutoResumeEnabled')"><label
                                    for="preferences-streams-auto-resume">{{ $t("ui.preferences_streams_auto_resume") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-streams-inbound-vu-meter-enabled"
                                    v-model="isStreamInboundVuMeterEnabled" v-on:change="storeSet('isStreamInboundVuMeterEnabled')"><label
                                    for="preferences-streams-inbound-vu-meter-enabled">{{ $t("ui.preferences_streams_inbound_vu_meter_enabled") }}</label>
                            </div>
                        </div>
                        <div class='popup-section'>
                            <div class='popup-header'>{{ $t("ui.preferences_title_toolbar") }}</div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-command-section-visible"
                                    v-model="isCommandSectionVisible" v-on:change="storeSet('isCommandSectionVisible')"><label
                                    for="preferences-command-section-visible">{{ $t("ui.preferences_command_section_visible") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-move-section-visible"
                                    v-model="isMoveSectionVisible" v-on:change="storeSet('isMoveSectionVisible')"><label
                                    for="preferences-move-section-visible">{{ $t("ui.preferences_move_section_visible") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-bubble-section-visible"
                                    v-model="isBubbleSectionVisible" v-on:change="storeSet('isBubbleSectionVisible')"><label
                                    for="preferences-bubble-section-visible">{{ $t("ui.preferences_bubble_section_visible") }}</label>
                            </div>
                            <div class='popup-item'>
                                <input type="checkbox" id="preferences-logout-button-visible"
                                    v-model="isLogoutButtonVisible" v-on:change="storeSet('isLogoutButtonVisible')"><label
                                    for="preferences-logout-button-visible">{{ $t("ui.preferences_logout_button_visible") }}</label>
                            </div>
                        </div>
                    </div>
                    <div class="popup-buttons">
                        <button v-on:click="closePreferencesPopup">{{ $t("ui.popup_button_ok") }}</button>
                    </div>
                </div>

                <div class="popup-overlay" id="dialog-popup-overlay" v-if="isDialogPopupOpen" v-on:click="closeDialog"></div>
                <div class="popup" id="dialog-popup" v-if="isDialogPopupOpen">
                    <div class="popup-titlebar" v-if="dialogPopupTitle">
                        <div class="popup-title">{{ dialogPopupTitle }}</div>
                    </div>
                    <div class="popup-content">
                        <div class="popup-item">
                            {{ dialogPopupMessage }}
                        </div>
                    </div>
                    <div class="popup-buttons">
                        <button v-for="(buttonText, buttonIndex) in dialogPopupButtons" v-on:click="closeDialog(buttonIndex)">{{ buttonText }}</button>
                    </div>
                </div>

                <div class="popup-overlay" v-if="isDeviceSelectionOpen" v-on:click="cancelDeviceSelection"></div>
                <fieldset class="popup" v-if="isDeviceSelectionOpen" :disabled="waitingForDevicePermission">
                    <div class="popup-titlebar">
                        <div class="popup-title">{{ $t("ui.device_selection_title") }}</div>
                    </div>
                    <div class="popup-content">
                        <!-- AUDIO -->
                        <div class='popup-section' v-if="deviceList.filter(d => d.type == 'audioinput').length">
                            <div class='popup-header'>{{ $t("ui.device_selection_audio_devices") }}</div>
                            <div class='popup-item' v-for="device in deviceList.filter(d => d.type == 'audioinput')">
                                <input type="radio" :id="device.id" :value="device.id" v-model="selectedAudioDeviceId"><label
                                    :for="device.id">{{ device.name }}</label>
                            </div>
                        </div>
                        <!-- VIDEO -->
                        <div class='popup-section' v-if="deviceList.filter(d => d.type == 'videoinput').length">
                            <div class='popup-header'>{{ $t("ui.device_selection_video_devices") }}</div>
                            <div class='popup-item' v-for="device in deviceList.filter(d => d.type == 'videoinput')">
                                <input type="radio" :id="device.id" :value="device.id" v-model="selectedVideoDeviceId"><label
                                    :for="device.id">{{ device.name }}</label>
                            </div>
                        </div>
                    </div>
                    <div class="popup-buttons">
                        <button v-on:click="wantToStartStreaming">{{ $t("ui.stream_form_button_stream") }}</button>
                        <button v-on:click="cancelDeviceSelection">{{ $t("ui.popup_button_cancel") }}</button>
                    </div>
                </fieldset>
            </div>
            <div id="logged-out-page" v-if="appState == 'logout'" class="full-screen-page">
                {{ $t("msg.goodbye") }}
                <img src="characters/giko/front-standing.svg"/>
                <a href="/">{{ $t("ui.back_to_homepage") }}</a>
            </div>
            <div id="poop-page" v-if="appState == 'poop'" class="full-screen-page">
                💩
            </div>
            <div id="redirect-notice-page" v-if="appState == 'redirect_notice'" class="full-screen-page">
                ギコっぽいぽいのURLが変わりました。ブックマークとリンクを修正してください。<br>
                The Gikopoipoi URL has changed. Please update your bookmarks and links.<br>
                <a href='https://gikopoipoi.net/'>gikopoipoi.net</a>
            </div>
        </div>
    </div>

    <audio id="message-sound" src="message.mp3"></audio>
    <audio id="mention-sound" src="mention.mp3"></audio>
    <audio id="login-sound" src="login.mp3"></audio>
    <audio id="ka-ching-sound" src="ka-ching.mp3"></audio>
    
    <script src="/api/server_generated_bundle.js"></script>
    <script type="module" src="/src/frontend/main.ts"></script>
</body>

</html>
